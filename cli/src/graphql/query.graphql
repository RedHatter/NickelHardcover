query GetUserId {
	me {
		id
	}
}

query GetUserBookReadByIsnb($isbn: [String!]!, $user_id: Int!) {
	user_book_reads(
		where: {
			user_book: { user_id: { _eq: $user_id } }
			finished_at: { _is_null: true }
			edition: {
				_or: [
					{ asin: { _in: $isbn } }
					{ isbn_10: { _in: $isbn } }
					{ isbn_13: { _in: $isbn } }
				]
			}
		}
		order_by: { started_at: desc }
		limit: 1
	) {
		id
		paused_at
		started_at
		edition {
			id
			pages
			book {
				pages
			}
		}
	}
}

query GetUserBookReadById($book_id: Int!, $user_id: Int!) {
	user_book_reads(
		where: {
			user_book: { book_id: { _eq: $book_id }, user_id: { _eq: $user_id } }
			finished_at: { _is_null: true }
		}
		order_by: { started_at: desc }
		limit: 1
	) {
		id
		paused_at
		started_at
		edition {
			id
			pages
			book {
				pages
			}
		}
	}
}

query GetEdition($isbn: [String!]!, $user_id: Int!) {
	editions(
		where: {
			_or: [
				{ asin: { _in: $isbn } }
				{ isbn_10: { _in: $isbn } }
				{ isbn_13: { _in: $isbn } }
			]
		}
	) {
		id
		pages
		book {
			id
			pages
			user_books(where: { user_id: { _eq: $user_id } }) {
				id
				status_id
			}
		}
	}
}

query GetBook($book_id: Int!, $user_id: Int!) {
	books(where: { id: { _eq: $book_id } }) {
		id
		pages
		user_books(where: { user_id: { _eq: $user_id } }) {
			id
			status_id
			edition {
				pages
				id
			}
		}
		default_ebook_edition {
			id
			pages
		}
		default_cover_edition {
			id
			pages
		}
	}
}

mutation InsertUserBook($book_id: Int!, $edition_id: Int!, $status_id: Int!) {
	insert_user_book(
		object: {
			edition_id: $edition_id
			book_id: $book_id
			status_id: $status_id
		}
	) {
		user_book {
			id
			user_book_reads(
				where: { finished_at: { _is_null: true } }
				order_by: { started_at: desc }
				limit: 1
			) {
				id
				paused_at
				started_at
				edition {
					id
					pages
					book {
						pages
					}
				}
			}
		}
	}
}

mutation UpdateUserBookStatus($id: Int!) {
	update_user_book(id: $id, object: { status_id: 2 }) {
		id
		user_book {
			user_book_reads(
				where: { finished_at: { _is_null: true } }
				order_by: { started_at: desc }
				limit: 1
			) {
				id
				paused_at
				started_at
				edition {
					id
					pages
					book {
						pages
					}
				}
			}
		}
	}
}

mutation InsertRead(
	$user_book_id: Int!
	$edition_id: Int!
	$started_at: date!
	$progress_pages: Int!
) {
	insert_user_book_read(
		user_book_id: $user_book_id
		user_book_read: {
			edition_id: $edition_id
			started_at: $started_at
			progress_pages: $progress_pages
		}
	) {
		id
	}
}

mutation UpdateRead(
	$id: Int!
	$progress_pages: Int!
	$edition_id: Int!
	$started_at: date!
) {
	update_user_book_read(
		id: $id
		object: {
			edition_id: $edition_id
			started_at: $started_at
			progress_pages: $progress_pages
		}
	) {
		id
	}
}

query SearchBooks($query: String!, $limit: Int!, $page: Int!) {
	search(query: $query, query_type: "Book", per_page: $limit, page: $page) {
		results
	}
}
